!function($){"use strict";function log(){"console"in window&&console.log.apply(console,arguments)}function warn(){"console"in window&&console.warn.apply(console,arguments)}function alertMessage(message,success){var color;color=success?"#4caf50":"#f44336",$('<div id="fw-alert" style="background-color:'+color+'">'+message+"</div>").hide().appendTo("#wpbody-content").slideDown().delay(3e3).slideUp()}function renderBlockAction(type){var headingHtml='<div class="fw-block-action">';return headingHtml+='<i class="fa fa-remove fw-remove-block" title="remove element" aria-hidden="true"></i>',headingHtml+='<i class="fa fa-caret-down fw-toggle-block" aria-hidden="true"></i>',headingHtml+='<i class="fa fa-arrows fw-move-block" aria-hidden="true"></i>',headingHtml+='<h4 class="fw-block-hndle">&nbsp;'+type+"</h4>",headingHtml+="</div>"}function renderRadioHeader(radioHeader){var radioHeaderHtml='<div class="fw-radio-option-element" data-type="header"><label>Label</label>';return radioHeaderHtml+='<input type="text" class="fw-radio-header fw-block-label" value="'+radioHeader+'"></input>',radioHeaderHtml+="</div>"}function renderRadioOption(radioOption,idx){var radioOptionHtml='<div class="fw-radio-option-element" data-type="option">';return radioOptionHtml+='<input type="text" class="fw-radio-option" placeholder="Option '+idx+'" value="'+radioOption+'"></input>',radioOptionHtml+='<div class="fw-remove-radio-option"><i class="fa fa-minus-circle" aria-hidden="true"></i></div></div>'}function renderRadio(radio){log("radio",radio);var i,n,element,optCount=0,radioHtml="";for(radioHtml+='<div class="fw-radio-option-container">',i=0,n=radio.elements.length;i<n;i++)element=radio.elements[i],log("element",element),"option"===element.type?(1==i&&(radioHtml+="<label>Options</label>"),radioHtml+=renderRadioOption(element.value,1+optCount++)):radioHtml+=renderRadioHeader(element.value);return radioHtml+="</div>",radioHtml+='<button class="fw-radio-add button-secondary"><i class="fa fa-plus" aria-hidden="true"></i> Add radio option</button><br/>',radioHtml+='<input type="checkbox" class="fw-required"'+checkRequired(radio)+"/><label>choice required</label>"}function renderSubmit(block){return"<p>Contains a field for name and email</p>"}function renderCheckbox(block){log("checkbox",block);var textHtml="";return textHtml+="<label>Label</label>",textHtml+='<input type="text" class="fw-text-label fw-block-label" placeholder="Label" value="'+block.label+'"></input><br/>',textHtml+='<input type="checkbox" class="fw-required"'+checkRequired(block)+"/><label>require checked</label>"}function renderTextInput(block){log("textInput",block);var textHtml="";return textHtml+="<label>Label</label>",textHtml+='<input type="text" class="fw-text-label fw-block-label" placeholder="Label" value="'+block.label+'"></input><br/>',textHtml+='<input type="checkbox" class="fw-required"'+checkRequired(block)+"/><label>required</label>"}function renderTextArea(block){log("textArea",block);var textAreaHtml="";return textAreaHtml+="<label>Label</label>",textAreaHtml+='<input type="text" class="fw-textarea-label fw-block-label" placeholder="Label" value="'+block.label+'"></input><br/>',textAreaHtml+='<input type="checkbox" class="fw-required"'+checkRequired(block)+"/><label>required</label>"}function renderBlock(block){log("block",block);var error=!1,blockHtml='<div class="fw-step-block" data-type="'+block.type+'" >';switch(blockHtml+=renderBlockAction(block.type),blockHtml+='<div class="fw-block-fields">',block.type){case"radio":block.elements||(block.elements=[{type:"header",value:""},{type:"option",value:""}]),blockHtml+=renderRadio(block);break;case"checkbox":blockHtml+=renderCheckbox(block);break;case"text":blockHtml+=renderTextInput(block);break;case"textarea":blockHtml+=renderTextArea(block);break;case"submit":$(".fw-step-block[data-type=submit]").length<1?blockHtml+=renderSubmit(block):(error=!0,alertMessage("ERROR: Only one submit block allowed",!1))}return blockHtml+="</div>",blockHtml+='<div class="fw-clearfix"></div>',blockHtml+="</div>",error&&(blockHtml=""),blockHtml}function renderBlocks(blocks){var i,n,blocksHtml="";for(i=0,n=blocks.length;i<n;i++)blocksHtml+=renderBlock(blocks[i]);return blocksHtml}function renderPart(part,partClass){log("part",part);var partHtml='<div class="'+partClass+'">';return partHtml+='<input type="text" class="fw-part-title" value="'+part.title+'" placeholder="'+wizard.i18n.partTitle+'"></input>',partHtml+='<div class="fw-remove-part" title="remove section">',partHtml+='<i class="fa fa-times"></i>',partHtml+='</div><div class="inside">',partHtml+=renderBlocks(part.blocks),partHtml+='</div><div class="fw-add-element">',partHtml+='<a href="#TB_inline?width=400&height=200&inlineId=fw-thickbox-content" class="thickbox"><i class="fa fa-plus"></i><br> drag and drop elements or click here to add elements</a>',partHtml+="</div>",partHtml+="</div>"}function getPartClass(i,n){var partClass="fw-step-part";return partClass}function renderParts(parts){var i,n=parts.length,partsHtml='<div><div class="fw-parts-header"><h3>Sections</h3></div>';partsHtml+='<div class="fw-column-buttons">',partsHtml+='<button type="button" class="fw-button-one-column"><i class="fa fa-align-justify"></i></button>',partsHtml+='<button type="button" class="fw-button-two-columns"><i class="fa fa-align-justify"></i> <i class="fa fa-align-justify"></i></button>',partsHtml+="</div>";var i,n;for(i=0,n=parts.length;i<n;i++){var partClass=getPartClass(i,n);partsHtml+=renderPart(parts[i],partClass)}return partsHtml+='<div class="fw-parts-footer">',partsHtml+='<a class="fw-add-part button-secondary"><i class="fa fa-plus"></i> Add Section</a>',partsHtml+="</div>",partsHtml+="</div>"}function renderStepInside(step,idx){var headlineId="fw-headline-"+idx,copyTextId="fw-copy-text-"+idx,stepHtml='<div class="fw-step"><div class="form-wrap">';return stepHtml+='<div class="input form-field">',stepHtml+='<input type="text" class="fw-step-title" value="'+step.title+'" placeholder="'+wizard.i18n.title+'"></input>',stepHtml+="</div>",stepHtml+='<div class="input form-field">',stepHtml+='<label for="'+headlineId+'"><b>'+wizard.i18n.headline+"</b></label>",stepHtml+='<input type="text" class="fw-step-headline" value="'+step.headline+'"></input>',stepHtml+="</div>",stepHtml+='<div class="input form-field">',stepHtml+='<label for="'+copyTextId+'"><b>'+wizard.i18n.copyText+"</b></label>",stepHtml+='<input type="text" class="fw-step-copy_text" value="'+step.copy_text+'"></input>',stepHtml+="</div>",stepHtml+='<div class="fw-step-parts">'+renderParts(step.parts)+"</div>",stepHtml+='</div><div class="fw-clearfix"></div></div>'}function renderStep(step){var stepHtml='<div class="postbox"><div class="fw-collapsediv"><i class="fa fa-caret-down" aria-hidden="true"></i></div><div class="fw-movediv hndle ui-sortable-handle"><i class="fa fa-arrows"></i></div><h1 class="fw-step-h1 hndle ui-sortable-handle"><span>'+step.title+'</span></h1><div class="fw-trashdiv" title="remove step"><i class="fa fa-trash"></i></div><div class="fw-clearfix"></div>'+renderStepInside(step)+'<div class="fw-clearfix"></div></div>';return stepHtml}function renderMailSettings(mailSettings){mailSettings&&(mailSettings.subject&&$(".fw-mail-subject").val(mailSettings.subject),mailSettings.to&&$(".fw-mail-to").val(mailSettings.to),mailSettings.header&&$(".fw-mail-header").val(mailSettings.header))}function renderSteps(steps){var i,n,stepsHtml='<div class="postbox-container"><div class="metabox-holder"><div class="meta-box-sortables">';for(i=0,n=steps.length;i<n;i++)stepsHtml+=renderStep(steps[i],i);stepsHtml+="</div></div></div>",$(container).html(stepsHtml)}function getRadioElementData($element){var data={},type=data.type=$element.attr("data-type");return"option"===type?data.value=$element.find(".fw-radio-option").val():"header"===type&&(data.value=$element.find(".fw-radio-header").val()),data}function getRadioData($radio,radio){var elements=radio.elements=[];$radio.find(".fw-radio-option-element").each(function(idx,element){elements.push(getRadioElementData($(element)))}),radio.required=$radio.find(".fw-required").prop("checked")}function getCheckboxData($checkbox,checkbox){checkbox.label=$checkbox.find(".fw-text-label").val(),checkbox.required=$checkbox.find(".fw-required").prop("checked")}function getTextData($text,text){text.label=$text.find(".fw-text-label").val(),text.required=$text.find(".fw-required").prop("checked")}function getTextareaData($text,text){text.label=$text.find(".fw-textarea-label").val(),text.required=$text.find(".fw-required").prop("checked")}function getBlockData($block){var block={},type=block.type=$block.attr("data-type");switch(type){case"radio":getRadioData($block,block);break;case"checkbox":getCheckboxData($block,block);break;case"text":getTextData($block,block);break;case"textarea":getTextareaData($block,block);break;case"submit":}return block}function getPartData($part){var part={};part.title=$part.find(".fw-part-title").val();var blocks=part.blocks=[];return $part.find(".fw-step-block").each(function(idx,element){blocks.push(getBlockData($(element)))}),part}function getStepData($step){var step={};step.title=$step.find(".fw-step-title").val(),step.headline=$step.find(".fw-step-headline").val(),step.copy_text=$step.find(".fw-step-copy_text").val();var parts=step.parts=[];return $step.find(".fw-step-part").each(function(idx,element){parts.push(getPartData($(element)))}),step}function getMailData(){var mailData={};return mailData.subject=$(".fw-mail-subject").val(),mailData.to=$(".fw-mail-to").val(),mailData.header=$(".fw-mail-header").val(),mailData}function removeStep(){var $this=$(this),$step=$this.closest(".postbox");$step.slideUp("slow",function(){$step.remove()})}function save(){var $container=$(container),title=$(".fw-wizard-title").val(),data={title:title,wizard:{}};data.wizard.steps=[],data.wizard.mail=getMailData(),$container.find(".fw-step").each(function(idx,element){data.wizard.steps.push(getStepData($(element)))}),log("save",data),log("ajaxurl",wizard.ajaxurl),log("nonce",wizard.nonce),$.ajax({type:"POST",url:wizard.ajaxurl,dataType:"json",data:{action:"fw_wizard_save",data:data,nonce:wizard.nonce,id:wizard.id},success:function(response){log("response",response),alertMessage(response.data.msg,response.success)},error:function(response){log("fail",arguments),log("response",response)}})}function setupDragNDrop(){$(".meta-box-sortables").sortable({opacity:.6,revert:!0,cursor:"move",handle:".hndle",tolerance:"pointer",placeholder:"fw-block-placeholder",update:function(event,ui){warn("sortables update",event,ui),$(ui.item).removeAttr("style"),setupDragNDrop()}}),$(".fw-step-part .inside").sortable({opacity:.6,cursor:"move",handle:".fw-block-hndle",tolerance:"intersect",placeholder:"fw-block-placeholder",revert:100,update:function(event,ui){warn("block sortables update",event,ui);var blockType=$(ui.item).attr("data-type");$(ui.item).is(".fw-draggable-block")&&$(ui.item).replaceWith($(renderBlock({type:blockType,label:""}))),setupDragNDrop(),setupClickHandlers()}});$(elementsContainer+" .fw-draggable-block").draggable({connectToSortable:".fw-step-part .inside",revert:"invalid",helper:"clone",cursor:"move"}),$(container).find(".fw-step-title").on("change input",titleOnChange)}function setupTooltips(){$(".fw-trashdiv").tooltip(),$(".fw-remove-part").tooltip(),$(".fw-remove-block").tooltip(),$(".hndle.ui-sortable-handle").tooltip()}function titleOnChange(evt){var $this=$(this);log("titleOnChangeU",$this.val()),$this.closest(".postbox").find("h1 > span").html($this.val())}function updateOptions($container){$container.find('.fw-radio-option-element[data-type="option"] > label').each(function(idx,elt){log("updateOptions",elt),$(elt).html("Option "+(idx+1))})}function addStep(){var part={title:"",blocks:[]},$step=$(renderStep({title:"",headline:"",copy_text:"",parts:[part]}));$step.appendTo($(container).find(".meta-box-sortables")),setupClickHandlers(),setupDragNDrop(),setupThickbox(),$("html, body").animate({scrollTop:$(document).height()},500)}function checkRequired(block){return"true"==block.required?"checked":""}function addPart(evt){var target=evt.target,$part=renderPart({title:"",blocks:[]},"fw-step-part");$(target).closest(".fw-parts-footer").before($part),$(".fw-remove-part").click(function(event){removePart(event)}),setupThickbox()}function removePart(evt){var target=evt.target;log("removing part",$(target).closest(".fw-step-part")),$(target).closest(".fw-step-part").remove()}function removeBlock(evt){var target=evt.target;log("removing block",$(target).closest(".fw-step-block")),$(target).closest(".fw-step-block").remove()}function setupThickbox(){$(".thickbox").click(function(thickEvent){$("#fw-thickbox-radio").unbind("click").click(function(thickRadioEvent){tb_remove();var block=$(renderBlock({type:"radio"})),$part=$(thickEvent.target).parents(".fw-step-part");$part.find(".inside").append(block),setupClickHandlers()}),$("#fw-thickbox-checkbox").unbind("click").click(function(thickRadioEvent){tb_remove();var block=$(renderBlock({type:"checkbox",value:""})),$part=$(thickEvent.target).parents(".fw-step-part");$part.find(".inside").append(block),setupClickHandlers()}),$("#fw-thickbox-text").unbind("click").click(function(thickRadioEvent){tb_remove();var block=$(renderBlock({type:"text",value:""})),$part=$(thickEvent.target).parents(".fw-step-part");$part.find(".inside").append(block),setupClickHandlers()}),$("#fw-thickbox-textarea").unbind("click").click(function(thickRadioEvent){tb_remove();var block=$(renderBlock({type:"textarea",value:""})),$part=$(thickEvent.target).parents(".fw-step-part");$part.find(".inside").append(block),setupClickHandlers()}),$("#fw-thickbox-submit").unbind("click").click(function(thickRadioEvent){tb_remove();var block=$(renderBlock({type:"submit",value:""})),$part=$(thickEvent.target).parents(".fw-step-part");$part.find(".inside").append(block),setupClickHandlers()})})}function setupClickHandlers(){$(".fw-element-step").unbind("click").click(function(event){addStep()}),$(".fw-add-part").unbind("click").click(function(event){addPart(event),setupDragNDrop()}),$(".fw-collapsediv").unbind("click").click(function(event){$(this).parent().find(".fw-step").slideToggle(),$(this).find(".fa").toggleClass("fa-caret-right")}),$(".fw-remove-part").click(function(event){removePart(event)}),$(".fw-remove-block").click(function(event){removeBlock(event)}),$(".fw-block-action > .fa-caret-down").unbind("click").click(function(event){$(this).parent().parent().toggleClass("fw-block-collapsed")}),$(".fw-remove-block").click(function(event){removeBlock(event)})}function run(){try{var w=JSON.parse(wizard.json),$container=$(container);log(wizard),log(w),$(".fw-wizard-title").val(w.title),renderSteps(w.wizard.steps),renderMailSettings(w.wizard.mail),$(".fw-button-save").click(save),$(window).scroll(function(){var offset=$(container).offset().top;return function(){var scrollTop=$(this).scrollTop();scrollTop>offset?$(elementsContainer).addClass("fw-sticky"):$(elementsContainer).removeClass("fw-sticky")}}()),$container.on("click",".postbox .handlediv",function(){$(this).closest(".postbox").toggleClass("closed")}),$container.on("click",".fw-radio-add",function(){var $cnt=$(this).prev(".fw-radio-option-container"),idx=$cnt.children(".fw-radio-option-element").length,opt=renderRadioOption("",idx);$(opt).appendTo($cnt),updateOptions($cnt)}),$container.on("click",".fw-remove-radio-option",function(){log("remove on click");var $this=$(this),$container=$this.closest(".fw-radio-option-container");$this.closest(".fw-radio-option-element").remove(),updateOptions($container)}),$container.on("click",".fw-trashdiv",removeStep),$(".fw-remove-part").tooltip({content:"Remove this section"}),setupDragNDrop(),setupTooltips(),setupThickbox(),setupClickHandlers(),$("#fw-nav-mail").click(function(e){$("#fw-nav-steps").toggleClass("nav-tab-active"),$("#fw-nav-mail").toggleClass("nav-tab-active"),$(container).hide(),$(elementsContainer).hide(),$(".fw-mail-settings-container").show()}),$("#fw-nav-steps").click(function(e){$("#fw-nav-steps").toggleClass("nav-tab-active"),$("#fw-nav-mail").toggleClass("nav-tab-active"),$(".fw-mail-settings-container").hide(),$(container).show(),$(elementsContainer).show()}),$("#fw-elements-modal").dialog({dialogClass:"wp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!0,buttons:{Close:function(){$(this).dialog("close")}}})}catch(ex){warn(ex)}}var container="#fw-wizard-container",elementsContainer="#fw-elements-container";$(document).ready(run)}(jQuery);